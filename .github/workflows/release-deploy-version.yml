# This workflow builds and deploys the project to Maven Central.
# It is triggered on a push event for tags matching 'v*.*.*' (e.g., v1.2.3),
# or can be triggered manually.
# Before deployment, tests are executed against both SLF4J 1.7.x and 2.0.x
# to ensure compatibility with both versions.
name: Release and Deploy Version

on:
  push:
    tags:
      - 'v*.*.*' # Triggers on any tag starting with 'v'
  workflow_dispatch:

permissions:
  contents: write # to fetch code (actions/checkout) and push tags

jobs:
  # Test with both SLF4J versions before deploying
  test-compatibility:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        slf4j-profile: [slf4j-1.7, slf4j-2.0]
      fail-fast: true # Stop if any version fails
    name: Test with ${{ matrix.slf4j-profile }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Test with ${{ matrix.slf4j-profile }}
        run: sh mvnw clean verify -P ${{ matrix.slf4j-profile }} --batch-mode

  # Deploy only after all tests pass
  build-release-deploy:
    needs: test-compatibility
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          gpg-private-key: ${{ secrets.GPG_SIGNING_KEY }}
          server-id: maven-central
          server-username: MAVEN_CENTRAL_USERNAME
          server-password: MAVEN_CENTRAL_PASSWORD

      - name: Build and Deploy (with SLF4J 1.7 profile)
        run: sh mvnw -ntp clean deploy -P release,slf4j-1.7 --batch-mode
        env:
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          MAVEN_CENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_USERNAME }}
          MAVEN_CENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_PASSWORD }}

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            gh release create ${{ github.ref_name }} \
              --generate-notes \
              --title "Version ${{ github.ref_name }}"
              
      - name: Upload Release Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
            gh release upload ${{ github.ref_name }} \
              ./target/*.jar --clobber
